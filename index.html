<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Obscur 7Wands</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    body {
      font-family: "Space Grotesk", "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(160deg, #37A64A, #308C3F);
      min-height: 100vh;
    }
    .site-header {
      background: linear-gradient(135deg, #20612D, #133B1B);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }
    .site-header.has-custom-bg {
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .header-divider {
      height: 6px;
      background: #000;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
    }
    .header-outline {
      -webkit-text-stroke: 1.4px rgba(0, 0, 0, 0.9);
      text-shadow:
        -2px 0 4px rgba(0, 0, 0, 0.85),
        2px 0 4px rgba(0, 0, 0, 0.85),
        0 -2px 4px rgba(0, 0, 0, 0.85),
        0 2px 4px rgba(0, 0, 0, 0.85);
    }
    .header-outline .snake-emote {
      -webkit-text-stroke: 0;
      text-shadow: none;
    }
    button[data-section] {
      background: linear-gradient(135deg, #1c7d31, #0e2617);
      border: 1px solid rgba(0, 0, 0, 0.9);
      color: rgba(255, 255, 255, 0.92);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
    }
    button[data-section]:hover {
      border-color: #000;
      filter: brightness(1.12);
    }
    .module-surface {
      background: linear-gradient(140deg, #2f6840, #1d3c24) !important;
      border-color: rgba(255, 255, 255, 0.22) !important;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 20px 45px rgba(0, 0, 0, 0.2);
      outline: 1px solid rgba(0, 0, 0, 0.75);
      outline-offset: -2px;
    }
    .module-surface :where(.rounded-3xl, .rounded-2xl, .rounded-xl, .rounded-lg, .rounded-md, .item-card, .map-thumb, .map-preview-frame) {
      background: linear-gradient(145deg, rgba(74, 142, 92, 0.85), rgba(32, 66, 44, 0.85)) !important;
      border-color: rgba(0, 0, 0, 0.6) !important;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 12px 28px rgba(0, 0, 0, 0.3);
    }
    .module-surface :where(.rounded-full) {
      background: linear-gradient(145deg, rgba(123, 192, 140, 0.55), rgba(39, 72, 48, 0.78)) !important;
      border-color: rgba(0, 0, 0, 0.5) !important;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 6px 16px rgba(0, 0, 0, 0.22);
    }
    .module-surface :where(table, thead, tbody tr) {
      background: linear-gradient(145deg, rgba(52, 96, 64, 0.9), rgba(26, 48, 34, 0.9));
    }
    .animate-fade {
      animation: fade 0.6s ease forwards;
    }
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(18px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    button[data-section].is-active {
      background: rgba(94, 234, 212, 0.15);
      border-color: rgba(94, 234, 212, 0.8);
      color: #99f6e4;
    }
    .toast {
      opacity: 0;
      transform: translateY(10px) scale(0.98);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .toast.shown {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    .item-card {
      position: relative;
    }
    .delete-item {
      position: absolute;
      top: -12px;
      right: -12px;
      width: 36px;
      height: 36px;
      border-radius: 9999px;
      border: none;
      background: #dc2626;
      color: #fff;
      font-weight: 700;
      font-size: 0.9rem;
      display: grid;
      place-items: center;
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.35);
      opacity: 0;
      pointer-events: none;
      transform: scale(0.85);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .list-editing li[data-id] {
      cursor: grab;
    }
    .list-editing li[data-id]:active {
      cursor: grabbing;
    }
    .list-editing .delete-item {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }
    .list-editing li.dragging {
      opacity: 0.55;
    }
    .map-gallery {
      display: grid;
    }
    .map-thumb {
      position: relative;
    }
    .map-thumb .delete-item {
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
    }
    .map-gallery .delete-item {
      opacity: 0;
      pointer-events: none;
      transform: scale(0.85);
    }
    .map-gallery.editing .delete-item {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }
    .delete-item.is-visible {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }
    .map-preview-frame {
      cursor: zoom-in;
    }
    .map-preview-frame img {
      pointer-events: none;
    }
    .editor-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.78);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      z-index: 60;
    }
    .editor-panel {
      width: min(560px, calc(100% - 2rem));
      max-height: min(90vh, 760px);
      border-radius: 1.5rem;
      overflow-y: auto;
      scrollbar-gutter: stable both-edges;
    }
    .emoji-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.78);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      z-index: 70;
    }
    .emoji-overlay.is-visible {
      display: flex;
    }
    .emoji-panel {
      width: min(720px, 100%);
      max-height: 90vh;
      border-radius: 1.5rem;
      display: flex;
      flex-direction: column;
    }
    .bg-editor-panel {
      width: min(620px, 100%);
      max-height: 80vh;
    }
    .emoji-scroll {
      overflow: auto;
      max-height: 60vh;
      border-radius: 1.25rem;
    }
    .emoji-table th,
    .emoji-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    .emoji-table th {
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.7);
    }
    .emoji-table tbody tr:last-child td {
      border-bottom: none;
    }
    .emoji-table tbody tr:hover {
      background: rgba(45, 212, 191, 0.08);
    }
    .editor-panel select {
      background: linear-gradient(140deg, #2f6840, #1d3c24) !important;
      color: #fff !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }
    .editor-panel select option {
      background: #1d3c24;
      color: #fff;
    }
  </style>
</head>
<body class="text-slate-100">
  <div class="min-h-screen flex flex-col">
    <header class="site-header sticky top-0 z-30 border-b border-white/10">
      <div class="relative mx-auto flex w-full max-w-6xl flex-col items-center gap-4 px-6 py-5 text-center">
        <div class="flex flex-col items-center">
          <p class="text-4xl tracking-[0.35em] text-white header-outline">OBSCUR</p>
          <h1 id="headerTitle" class="text-2xl font-bold text-white header-outline"><span class="snake-emote">ğŸ</span> 7Wands <span class="snake-emote">ğŸ</span></h1>
        </div>
        <nav class="flex flex-wrap justify-center gap-3 text-sm font-semibold">
          <button data-section="accueil" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸ  Accueil ğŸ </button>
          <button data-section="recettes-cuisines" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸ³ Recettes cuisines ğŸ³</button>
          <button data-section="recettes-potions" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸ§ª Recettes potions ğŸ§ª</button>
          <button data-section="sorts" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸ”± Sorts ğŸ”±</button>
          <button data-section="cours" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸ’¼ Cours ğŸ’¼</button>
          <button data-section="creatures" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸ‰ CrÃ©atures ğŸ‰</button>
          <button data-section="ingredients" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸŒ± IngrÃ©dients ğŸŒ±</button>
          <button data-section="botanique" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸŒ¿ Botanique ğŸŒ¿</button>
          <button data-section="notes" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸ“ Notes ğŸ“</button>
          <button data-section="carte" class="rounded-full border border-white/10 px-4 py-2 text-white/80 transition hover:border-white/40">ğŸ—ºï¸ Cartes ğŸ—ºï¸</button>
        </nav>
      </div>
    </header>
    <div class="header-divider"></div>

    <main class="flex-1 px-6 py-10">
      <div id="content" class="mx-auto max-w-5xl"></div>
    </main>

    <input type="file" accept="image/*" id="headerBgInput" class="hidden" />
    <input type="file" accept="image/*" id="bodyBgInput" class="hidden" />

    <footer class="border-t border-white/10 px-6 py-6 text-xs text-white/70">
      <div class="mx-auto max-w-5xl relative flex items-center justify-center">
        <button id="emojiToggle" class="absolute left-0 text-left text-white/80 underline-offset-4 hover:text-white hover:underline">Code Emoticone</button>
        <p class="w-full text-center">Obscur 7Wands Â· PropriÃ©tÃ© de ObscurCorp.</p>
        <button id="bgEditorToggle" class="absolute right-0 text-right text-white/80 underline-offset-4 hover:text-white hover:underline">Image ArriÃ¨re Plan</button>
      </div>
    </footer>

  <div id="bgEditorOverlay" class="emoji-overlay">
    <div class="emoji-panel bg-editor-panel module-surface border border-white/10 p-6 shadow-2xl shadow-black/40">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.4em] text-white/70">Personnalisation</p>
          <h3 class="mt-1 text-2xl font-semibold text-white">ArriÃ¨re-plans personnalisÃ©s</h3>
        </div>
        <button id="closeBgEditor" class="rounded-full border border-white/30 px-3 py-1 text-xs font-semibold text-white/80 transition hover:border-cyan-300 hover:text-white">Fermer</button>
      </div>
      <p class="mt-4 text-sm text-white/80">Choisissez une image diffÃ©rente pour lâ€™en-tÃªte ou pour le fond gÃ©nÃ©ral de lâ€™application.</p>
      <div class="mt-6 grid gap-4 sm:grid-cols-2">
        <button id="editHeaderBg" class="module-surface rounded-2xl border border-white/20 px-4 py-3 text-sm font-semibold text-white/90 hover:border-cyan-200">En-tÃªte</button>
        <button id="editBodyBg" class="module-surface rounded-2xl border border-white/20 px-4 py-3 text-sm font-semibold text-white/90 hover:border-cyan-200">Fond</button>
      </div>
    </div>
  </div>

  <div id="emojiOverlay" class="emoji-overlay">
    <div class="emoji-panel module-surface border border-white/10 p-8 shadow-2xl shadow-black/40">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.4em] text-white/70">RÃ©fÃ©rence secrÃ¨te</p>
          <h3 class="mt-1 text-2xl font-semibold text-white">Emoji Unicode Tables</h3>
        </div>
        <button id="closeEmoji" class="rounded-full border border-white/30 px-3 py-1 text-xs font-semibold text-white/80 transition hover:border-cyan-300 hover:text-white">Fermer</button>
      </div>
      <p class="mt-4 text-sm text-white/80">Explorez cette petite collection dâ€™Ã©moticÃ´nes mystiques et leurs codes Unicode.</p>
      <div class="mt-6 emoji-scroll border border-white/10">
        <table class="emoji-table w-full text-left text-sm text-white/90">
          <thead class="bg-white/5 sticky top-0">
            <tr>
              <th scope="col">Emoji</th>
              <th scope="col">Code Unicode</th>
            </tr>
          </thead>
          <tbody id="emojiTableBody">
            <tr><td class="text-sm text-white/70" colspan="2">Chargementâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  </div>

  <div id="toast-stack" class="pointer-events-none fixed.bottom-6 right-6 z-50 flex flex-col gap-3"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const STORAGE_KEY = 'obscur-7wands-data';
      const content = document.getElementById('content');
      const navButtons = document.querySelectorAll('[data-section]');
      const toastStack = document.getElementById('toast-stack');
      const siteHeader = document.querySelector('.site-header');
      const headerTitle = document.getElementById('headerTitle');
      const headerBgInput = document.getElementById('headerBgInput');
      const bodyBgInput = document.getElementById('bodyBgInput');
      const mapImageUrl = 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80';
      let customMapGallery = [];
      let activeMapIndex = 0;
      let mapGalleryEditing = false;
      let mapReplaceMode = false;
      let mapReplaceTargetIndex = null;
      let currentSection = 'accueil';
      let headerBackgroundUrl = '';
      let bodyBackgroundUrl = '';

      const persistState = () => {
        try {
          const payload = JSON.stringify({ library, customMapGallery, activeMapIndex, headerBackgroundUrl, bodyBackgroundUrl });
          localStorage.setItem(STORAGE_KEY, payload);
        } catch (error) {
          console.warn('Impossible d\'enregistrer la session', error);
        }
      };

      const hydrateState = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object') {
            if (parsed.library && typeof parsed.library === 'object') {
              Object.keys(library).forEach((key) => {
                if (Array.isArray(parsed.library[key])) {
                  library[key] = parsed.library[key];
                }
              });
            }
            if (Array.isArray(parsed.customMapGallery)) {
              customMapGallery = normalizeMapGallery(parsed.customMapGallery);
            }
            if (typeof parsed.activeMapIndex === 'number') {
              activeMapIndex = Math.max(0, Math.min(parsed.activeMapIndex, Math.max(customMapGallery.length - 1, 0)));
            }
            if (typeof parsed.headerBackgroundUrl === 'string') {
              headerBackgroundUrl = parsed.headerBackgroundUrl;
              applyHeaderBackground();
            }
            if (typeof parsed.bodyBackgroundUrl === 'string') {
              bodyBackgroundUrl = parsed.bodyBackgroundUrl;
              applyBodyBackground();
            }
          }
        } catch (error) {
          console.warn('Impossible de charger la session', error);
        }
      };

      const order = ['recettes-cuisines', 'recettes-potions', 'sorts', 'cours', 'creatures', 'ingredients', 'botanique', 'notes', 'carte'];
      const bookMeta = {
        'recettes-cuisines': {
          label: 'Recettes Cuisines',
          description: 'Festins mystiques, relevÃ©s de sortilÃ¨ges gustatifs et dâ€™Ã©pices astrales.'
        },
        'recettes-potions': {
          label: 'Recettes Potions',
          description: 'Elixirs, sÃ©rums et distillations luminescentes pour chaque rituel.'
        },
        'sorts': {
          label: 'Sorts',
          description: 'Grimoire de sorts, incantations et effets magiques canalisÃ©s.'
        },
        'cours': {
          label: 'Cours',
          description: 'Curriculum des arts occultes, sessions pratiques et exercices guidÃ©s.'
        },
        'creatures': {
          label: 'ğŸ‰ CrÃ©atures ğŸ‰',
          description: 'Bestiaire vivant : profils, dangers et habitats des entitÃ©s rencontrÃ©es.'
        },
        'ingredients': {
          label: 'IngrÃ©dients',
          description: 'Index aromatique des essences rares, champignons lunaires et sels prismatiques.'
        },
        'botanique': {
          label: 'Botanique',
          description: 'Herbier Ã©sotÃ©rique : plantes, fleurs, spores et baies aux vertus secrÃ¨tes.'
        },
        'notes': {
          label: 'Notes',
          description: 'Carnets dâ€™observations, annotations rituelles et mÃ©mos de laboratoire.'
        },
        'carte': {
          label: 'Cartes',
          description: 'Atlas arcanique des territoires inexplorÃ©s et routes de convocation.'
        }
      };

      const ingredientCategories = new Set(['recettes-cuisines', 'recettes-potions']);
      const ingredientUsageLabels = {
        cuisine: 'IngrÃ©dients Cuisine',
        potion: 'IngrÃ©dients Potion'
      };
      const sectionsWithEditTips = new Set(['recettes-cuisines', 'recettes-potions', 'cours', 'creatures', 'ingredients', 'notes']);

      let library = {
        'recettes-cuisines': [
          { id: 'cuisine-1', title: 'SoufflÃ© Astral', content: 'Un nuage salÃ©, gonflÃ© par des vents stellaires et parfumÃ© aux herbes lunaires.', ingredients: 'Blancs dâ€™Å“uf astrals, herbes lunaires, poudre de stardust.' },
          { id: 'cuisine-2', title: 'RagoÃ»t des Veilleurs', content: 'LÃ©gumes racines caramÃ©lisÃ©s, bouillon de comÃ¨te et miettes de quartz comestible.', ingredients: 'Racines caramÃ©lisÃ©es, bouillon de comÃ¨te, Ã©clats de quartz.' }
        ],
        'recettes-potions': [
          { id: 'potion-1', title: 'Ã‰lixir du CrÃ©puscule', content: 'Infusion ambrÃ©e qui Ã©quilibre lâ€™esprit aprÃ¨s un long voyage astral.', ingredients: 'PÃ©tales de crÃ©puscule, ambre liquide, eau des songes.', effects: 'RÃ©-Ã©quilibre le flux astral et stabilise les sens.', incantation: 'Murmuros astralis, ramenez lâ€™Ã©quilibre de la nuit.' },
          { id: 'potion-2', title: 'Distillat de Givre', content: 'Potion translucide qui apaise les brÃ»lures dâ€™Ã©nergie et rÃ©initialise le mana.', ingredients: 'Givre Ã©ternel, menthe astrale, cristaux de mana.', effects: 'Apaise les brÃ»lures dâ€™Ã©nergie et relance la rÃ©serve de mana.', incantation: 'Gelum animae, apaisez la braise intÃ©rieure.' }
        ],
        'sorts': [
          { id: 'sort-1', title: 'Orbe de brume', content: 'Un voile de brume qui masque la prÃ©sence et rÃ©duit les sons environnants.' },
          { id: 'sort-2', title: 'Trait prismatique', content: 'Projectile de lumiÃ¨re rÃ©fractÃ©e infligeant des dÃ©gÃ¢ts spectraux.' }
        ],
        'cours': [
          { id: 'cours-1', title: 'ChorÃ©graphies de runes', content: 'SÃ©ance pratique sur lâ€™Ã©criture gestuelle des glyphes protecteurs.', professor: 'Prof. Selene' },
          { id: 'cours-2', title: 'Herboristerie noire', content: 'DÃ©couverte guidÃ©e des plantes nocturnes aux propriÃ©tÃ©s instables.', professor: 'MaÃ®tre Orphos' }
        ],
        'creatures': [
          { id: 'creature-1', title: 'Lupus Prismatique', danger: 'Ã‰levÃ©e', size: '2 m au garrot', sex: 'Femelle', weight: '120 kg', physical: 'Pelage iridescent, crocs cristallins.', habitat: 'ForÃªts prismatiques', info: 'Voyage en meute rÃ©duite, hurlements qui dÃ©sorientent.', photo: '' },
          { id: 'creature-2', title: 'Gargouille de Brume', danger: 'Moyenne', size: '1,4 m', sex: 'MÃ¢le', weight: '80 kg', physical: 'Ailes de pierre poreuse, yeux luminescents.', habitat: 'Remparts oubliÃ©s', info: 'Se nourrit dâ€™Ã©clairs et protÃ¨ge les artefacts abandonnÃ©s.', photo: '' }
        ],
        'ingredients': [
          { id: 'ingredient-1', title: 'Pollen de Nyx', content: 'Grains luminescents rÃ©coltÃ©s au sommet des falaises nocturnes, utilisÃ©s pour stabiliser les sauces astrales.', location: 'Falaise de Nyx', usage: 'cuisine' },
          { id: 'ingredient-2', title: 'Sel prismatique', content: 'Cristaux multicolores qui amplifient la saveur et la portÃ©e des sortilÃ¨ges culinaires.', location: 'Salines prismatiques', usage: 'potion' }
        ],
        'botanique': [
          { id: 'botanique-1', title: 'Liane LumifÃ¨re', content: 'Plante grimpante bioluminescente utilisÃ©e pour Ã©clairer les serres nocturnes.', location: 'Serres suspendues de Lyria', usage: 'cuisine' }
        ],
        'notes': [
          { id: 'note-1', title: 'Essais sur la chaleur runique', content: 'Observations sur la maniÃ¨re dont la chaleur sÃ©raphique impacte les textures des potages enchantÃ©s.' },
          { id: 'note-2', title: 'MÃ©mo de service minuit', content: 'Rappels pour coordonner les tables dâ€™apprentis pendant les banquets nocturnes.' }
        ]
      };

      hydrateState();

      const editingState = {};

      function applyHeaderBackground() {
        if (!siteHeader) return;
        if (headerBackgroundUrl) {
          siteHeader.style.setProperty('background-image', `url(${headerBackgroundUrl})`);
          siteHeader.classList.add('has-custom-bg');
        } else {
          siteHeader.style.removeProperty('background-image');
          siteHeader.classList.remove('has-custom-bg');
        }
      }

      function applyBodyBackground() {
        if (!document.body) return;
        if (bodyBackgroundUrl) {
          document.body.style.setProperty('background-image', `url(${bodyBackgroundUrl})`);
          document.body.style.setProperty('background-size', 'cover');
          document.body.style.setProperty('background-position', 'center');
          document.body.style.setProperty('background-repeat', 'no-repeat');
        } else {
          document.body.style.removeProperty('background-image');
          document.body.style.removeProperty('background-size');
          document.body.style.removeProperty('background-position');
          document.body.style.removeProperty('background-repeat');
        }
      }

      function escapeHtml(str = '') {
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function createExcerpt(text = '', length = 90) {
        return text.length > length ? text.slice(0, length) + 'â€¦' : text;
      }

      function formatMultiline(text = '') {
        return escapeHtml(text).replace(/\n/g, '<br />');
      }

      function emoteToSymbol(input = '') {
        const trimmed = (input || '').trim();
        if (!trimmed) return '';
        if (/U\+/i.test(trimmed)) {
          const parts = trimmed
            .split(/\s+/)
            .map((part) => part.toUpperCase().replace(/^U\+/, ''))
            .filter(Boolean);
          const symbols = parts
            .map((part) => {
              const codePoint = parseInt(part, 16);
              return Number.isNaN(codePoint) ? '' : String.fromCodePoint(codePoint);
            })
            .join('');
          return symbols || trimmed;
        }
        return trimmed;
      }

      function getItemEmote(item = {}) {
        if (!item || typeof item !== 'object') return '';
        if (item.emote && item.emote.trim()) return item.emote.trim();
        if (item.emoteCode && item.emoteCode.trim()) {
          return emoteToSymbol(item.emoteCode);
        }
        return '';
      }

      function getDisplayTitle(item = {}) {
        const emote = getItemEmote(item);
        const safeTitle = escapeHtml(item?.title || '');
        if (emote) {
          return `${safeTitle}<span class="ml-1">${escapeHtml(emote)}</span>`;
        }
        return safeTitle;
      }

      function normalizeMapEntry(entry, idx = 0) {
        if (!entry) return null;
        const fallbackTitle = `Carte ${idx + 1}`;
        const stamp = Date.now();
        if (typeof entry === 'string') {
          return {
            id: `map-${stamp}-${idx}`,
            url: entry,
            title: fallbackTitle
          };
        }
        if (typeof entry === 'object' && entry.url) {
          const cleanedTitle = typeof entry.title === 'string' && entry.title.trim() ? entry.title.trim() : fallbackTitle;
          return {
            id: entry.id || `map-${stamp}-${idx}`,
            url: entry.url,
            title: cleanedTitle
          };
        }
        return null;
      }

      function normalizeMapGallery(entries = []) {
        return entries.map((entry, idx) => normalizeMapEntry(entry, idx)).filter(Boolean);
      }

      function findMapByTitle(title = '') {
        if (!title) return null;
        const normalized = title.trim().toLowerCase();
        return customMapGallery.find((entry) => entry.title.trim().toLowerCase() === normalized) || null;
      }

      function getActiveMapUrl() {
        if (!customMapGallery.length) {
          activeMapIndex = 0;
          return mapImageUrl;
        }
        if (activeMapIndex >= customMapGallery.length) {
          activeMapIndex = customMapGallery.length - 1;
        }
        return customMapGallery[activeMapIndex]?.url || mapImageUrl;
      }

      function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function promptMapName(defaultName, fileName = '') {
        const label = fileName ? `Nom pour ${fileName}` : 'Nom de la carte';
        const response = window.prompt(label, defaultName);
        return response && response.trim() ? response.trim() : defaultName;
      }

      function pushToast(message, tone = 'success') {
        if (!toastStack) return;
        const toast = document.createElement('div');
        toast.className = `toast rounded-2xl border px-4 py-2 text-sm shadow-2xl ${tone === 'danger'
          ? 'border-red-400/60 bg-red-500/20 text-red-100'
          : 'border-emerald-300/60 bg-emerald-400/10 text-emerald-100'}`;
        toast.textContent = message;
        toastStack.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('shown'));
        setTimeout(() => toast.classList.remove('shown'), 2600);
        setTimeout(() => toast.remove(), 3200);
      }

      function syncAndRender(callback) {
        if (typeof callback === 'function') {
          callback();
        }
        persistState();
        if (currentSection === 'accueil') {
          renderHome();
        } else if (currentSection === 'carte') {
          renderCarte();
        } else {
          renderCategory(currentSection);
        }
      }

      function handleHeaderBackgroundUpload(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) {
          event.target.value = '';
          return;
        }
        if (!file.type.startsWith('image/')) {
          pushToast('SÃ©lectionnez une image valide.', 'danger');
          event.target.value = '';
          return;
        }
        readFileAsDataURL(file)
          .then((dataUrl) => {
            headerBackgroundUrl = dataUrl;
            applyHeaderBackground();
            persistState();
            pushToast('Fond de lâ€™en-tÃªte mis Ã  jour.');
          })
          .catch(() => {
            pushToast('Impossible de charger cette image.', 'danger');
          })
          .finally(() => {
            event.target.value = '';
          });
      }

      function handleBodyBackgroundUpload(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) {
          event.target.value = '';
          return;
        }
        if (!file.type.startsWith('image/')) {
          pushToast('SÃ©lectionnez une image valide.', 'danger');
          event.target.value = '';
          return;
        }
        readFileAsDataURL(file)
          .then((dataUrl) => {
            bodyBackgroundUrl = dataUrl;
            applyBodyBackground();
            persistState();
            pushToast('Fond gÃ©nÃ©ral mis Ã  jour.');
          })
          .catch(() => {
            pushToast('Impossible de charger cette image.', 'danger');
          })
          .finally(() => {
            event.target.value = '';
          });
      }

      function setActiveNav(section) {
        navButtons.forEach((btn) => {
          btn.classList.toggle('is-active', btn.dataset.section === section);
        });
      }

      navButtons.forEach((btn) => {
        btn.addEventListener('click', () => showSection(btn.dataset.section));
      });

      function showSection(section) {
        currentSection = section;
        setActiveNav(section);
        if (section === 'accueil') {
          renderHome();
        } else if (section === 'carte') {
          renderCarte();
        } else {
          renderCategory(section);
        }
      }

      async function exportLibrary() {
        try {
          const payload = JSON.stringify({ library, customMapGallery, activeMapIndex }, null, 2);
          const now = new Date();
          const pad = (num) => String(num).padStart(2, '0');
          const dateLabel = `${pad(now.getDate())}-${pad(now.getMonth() + 1)}`;
          const fileName = `obscur-7wands-${dateLabel}.json`;

          if (window.showSaveFilePicker) {
            const fileHandle = await window.showSaveFilePicker({
              suggestedName: fileName,
              types: [
                {
                  description: 'Sauvegarde Obscur 7Wands',
                  accept: { 'application/json': ['.json'] }
                }
              ]
            });
            const writable = await fileHandle.createWritable();
            await writable.write(payload);
            await writable.close();
            pushToast('Sauvegarde enregistrÃ©e.');
          } else {
            const blob = new Blob([payload], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            pushToast('Sauvegarde exportÃ©e.');
          }
        } catch (error) {
          console.error(error);
          pushToast('Impossible dâ€™exporter la sauvegarde.', 'danger');
        }
      }

      function handleImportSelection(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const imported = JSON.parse(reader.result || '{}');
            if (!imported || typeof imported !== 'object' || typeof imported.library !== 'object') {
              throw new Error('Structure invalide');
            }
            syncAndRender(() => {
              Object.keys(library).forEach((key) => {
                if (Array.isArray(imported.library[key])) {
                  library[key] = imported.library[key];
                }
              });
              let nextGallery = Array.isArray(imported.customMapGallery)
                ? normalizeMapGallery(imported.customMapGallery)
                : [];
              if (!nextGallery.length && typeof imported.customMapUrl === 'string' && imported.customMapUrl) {
                nextGallery = normalizeMapGallery([imported.customMapUrl]);
              }
              customMapGallery = nextGallery;
              activeMapIndex = typeof imported.activeMapIndex === 'number'
                ? Math.min(Math.max(imported.activeMapIndex, 0), Math.max(customMapGallery.length - 1, 0))
                : 0;
            });
            pushToast('Sauvegarde importÃ©e.');
          } catch (error) {
            console.error(error);
            pushToast('Fichier de sauvegarde invalide.', 'danger');
          } finally {
            event.target.value = '';
          }
        };
        reader.onerror = () => {
          pushToast('Impossible de lire ce fichier.', 'danger');
          event.target.value = '';
        };
        reader.readAsText(file);
      }

      function renderHome() {
        const cards = order
          .filter((key) => key !== 'accueil')
          .map((key) => {
            const itemsForModule = key === 'carte'
              ? (customMapGallery.length ? customMapGallery : [{ title: 'Atlas Obscur', url: mapImageUrl }])
              : library[key] || [];
            const listMarkup = itemsForModule.length
              ? `<div class="mt-4 grid gap-2 sm:grid-cols-2">
                  ${itemsForModule.map((item) => `<div class="rounded-2xl border border-white/15 bg-white/5 px-3 py-2 text-sm text-white/90">${getDisplayTitle(item)}</div>`).join('')}
                </div>`
              : `<p class="mt-4 text-sm text-white/70">Ajoutez votre premier Ã©lÃ©ment pour commencer.</p>`;
            const mapThumbnail = key === 'carte'
              ? ''
              : '';
            return `
            <article data-open-section="${key}" class="module-surface rounded-3xl border border-white/10 p-6 transition hover:-translate-y-1 hover:border-white/40 cursor-pointer">
              <h3 class="text-2xl font-semibold text-white">${bookMeta[key].label}</h3>
              ${listMarkup}
              ${mapThumbnail}
            </article>`;
          }).join('');

        content.innerHTML = `
          <section class="space-y-8 animate-fade">
            <div class="grid gap-6 md:grid-cols-2">
              ${cards}
            </div>
            <div class="module-surface rounded-3xl border border-white/10 p-6 mt-6">
              <div class="flex flex-col items-stretch gap-4 md:flex-row md:justify-center">
                <div class="module-surface w-full rounded-2xl border border-white/10 p-4 md:w-72">
                  <h3 class="text-lg font-semibold text-white">Exporter</h3>
                  <p class="mt-1 text-xs text-white/80">Sauvegardez toutes vos donnÃ©es localement.</p>
                  <button id="exportData" class="mt-4 inline-flex items-center gap-2 rounded-full border border-black/70 bg-cyan-200/90 px-4 py-2 text-xs font-semibold text-white transition hover:bg-cyan-100">CrÃ©e une sauvegarde</button>
                </div>
                <div class="module-surface w-full rounded-2xl border border-white/10 p-4 md:w-72">
                  <h3 class="text-lg font-semibold text-white">Importer</h3>
                  <p class="mt-1 text-xs text-white/80">Chargez une sauvegarde prÃ©cÃ©dente.</p>
                  <button id="importData" class="mt-4 inline-flex items-center gap-2 rounded-full border border-white/40 px-4 py-2 text-xs font-semibold text-white transition hover:border-cyan-300">Choisir un fichier</button>
                  <input type="file" accept="application/json" id="importInput" class="hidden" />
                </div>
              </div>
            </div>
          </section>`;

        content.querySelectorAll('[data-open-section]').forEach((btn) => {
          btn.addEventListener('click', () => showSection(btn.dataset.openSection));
        });

        const exportBtn = document.getElementById('exportData');
        const importBtn = document.getElementById('importData');
        const importInput = document.getElementById('importInput');
        if (exportBtn) {
          exportBtn.addEventListener('click', exportLibrary);
        }
        if (importBtn && importInput) {
          importBtn.addEventListener('click', () => importInput.click());
          importInput.addEventListener('change', handleImportSelection);
        }
      }

      function renderCarte() {
        const meta = bookMeta['carte'];
        const activeMapUrl = getActiveMapUrl();
        const activeMapTitle = customMapGallery[activeMapIndex]?.title || 'Atlas Obscur';
        const galleryMarkup = customMapGallery.length
          ? customMapGallery.map((entry, index) => `
              <div class="map-thumb rounded-xl border ${index === activeMapIndex ? 'border-cyan-200/80 bg-white/10' : 'border-white/15 bg-white/5'} p-2">
                <div class="flex items-center gap-3">
                  <button type="button" data-map-index="${index}" class="group relative block h-20 w-28 overflow-hidden rounded-lg" ${mapReplaceMode ? `data-replace-target="${index}"` : ''}>
                    <img src="${entry.url}" alt="${escapeHtml(entry.title)}" class="h-full w-full object-cover" />
                    <span class="absolute inset-0 flex items-center justify-center bg-black/40 text-xs font-semibold uppercase tracking-[0.3em] text-white opacity-0 transition group-hover:opacity-100">${mapReplaceMode ? 'Choisir' : 'Voir'}</span>
                  </button>
                  <p class="text-sm font-semibold text-white/90">${escapeHtml(entry.title)}</p>
                </div>
                <button type="button" class="delete-item ${mapGalleryEditing ? 'is-visible' : ''}" data-delete-map="${index}" aria-label="Supprimer ${escapeHtml(entry.title)}">âœ•</button>
              </div>`).join('')
          : '<p class="text-sm text-white/80">Ajoutez plusieurs cartes pour constituer votre galerie personnelle.</p>';

        content.innerHTML = `
          <section class="space-y-8 animate-fade">
            <div class="module-surface rounded-3xl border border-white/10 p-8 shadow-2xl shadow-black/40">
              <h2 class="text-3xl font-bold text-white">${meta.label}</h2>
              <p class="mt-3 text-xs text-white/80">SÃ©lectionnez plusieurs images pour crÃ©er votre collection de cartes personnelles.</p>
              <div class="mt-6 flex flex-wrap gap-5">
                <div class="flex flex-col gap-1">
                  <button id="uploadMap" class="inline-flex items-center gap-2 rounded-full border border-white/30 bg-white/10 px-6 py-2 text-sm font-semibold text-white transition hover:bg-white/20">
                    â¬†ï¸ Charger des cartes
                  </button>
                </div>
                <div class="flex flex-col gap-1">
                  <button id="replaceMap" class="inline-flex items-center gap-2 rounded-full border border-amber-400/60 bg-amber-500/10 px-6 py-2 text-sm font-semibold text-amber-50 transition hover:bg-amber-500/20">
                    ${mapReplaceMode ? 'Terminer les remplacements' : 'âœï¸ Modifier une carte'}
                  </button>
                  ${mapReplaceMode ? '<p class="text-xs text-amber-100" id="replaceTips">Cliquez sur la photo Ã  changer dans ALBUM pour changer la photo.</p>' : ''}
                </div>
                <div class="flex flex-col gap-1">
                  <button id="toggleMapEditing" class="inline-flex items-center gap-2 rounded-full border border-red-400/60 bg-red-500/10 px-6 py-2 text-sm font-semibold text-red-100 transition hover:bg-red-500/20">
                    ${mapGalleryEditing ? 'Terminer les suppressions' : 'ğŸ—‘ï¸ Supprimer des cartes'}
                  </button>
                  ${mapGalleryEditing ? '<p class="text-xs text-red-100" id="deleteTips">Cliquez sur la croix rouge pour supprimÃ© une image.</p>' : ''}
                </div>
                <input type="file" accept="image/*" id="mapUpload" class="hidden" multiple />
                <input type="file" accept="image/*" id="mapReplaceInput" class="hidden" />
              </div>
            </div>
            <div class="module-surface rounded-3xl border border-white/10 p-6">
              <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_260px]">
                <div class="flex flex-col items-center gap-3">
                  <p class="text-sm font-semibold text-white/90">${escapeHtml(activeMapTitle)}</p>
                  <button type="button" class="map-preview-frame inline-flex items-center justify-center rounded-2xl border border-white/10 bg-slate-900/40 p-4" id="mapPreviewFrame" ${mapReplaceMode ? 'data-replace-target="preview"' : ''}>
                    <img id="mapPreview" src="${activeMapUrl}" alt="Carte mystique" class="max-h-[420px] w-auto max-w-full object-contain" />
                  </button>
                </div>
                <div>
                  <p class="text-xs uppercase tracking-[0.4em] text-white/70">Galerie</p>
                  <div id="mapGallery" class="map-gallery ${mapGalleryEditing ? 'editing' : ''} mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-1">
                    ${galleryMarkup}
                  </div>
                </div>
              </div>
            </div>
          </section>`;

        const previewFrame = document.getElementById('mapPreviewFrame');
        if (previewFrame) {
          previewFrame.addEventListener('click', () => openMapFullscreen(getActiveMapUrl()));
        }

        const uploadBtn = document.getElementById('uploadMap');
        const fileInput = document.getElementById('mapUpload');
        if (uploadBtn && fileInput) {
          uploadBtn.addEventListener('click', () => fileInput.click());
          fileInput.addEventListener('change', (event) => handleMapUpload(event));
        }
        const replaceBtn = document.getElementById('replaceMap');
        const replaceInput = document.getElementById('mapReplaceInput');
        if (replaceBtn && replaceInput) {
          replaceBtn.addEventListener('click', () => {
            mapReplaceMode = !mapReplaceMode;
            mapReplaceTargetIndex = null;
            renderCarte();
          });
          replaceInput.addEventListener('change', (event) => handleMapReplace(event));
        }

        content.querySelectorAll('[data-map-index]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const indexValue = Number(btn.dataset.mapIndex) || 0;
            if (mapReplaceMode) {
              mapReplaceTargetIndex = indexValue;
              const replaceInput = document.getElementById('mapReplaceInput');
              if (replaceInput) {
                replaceInput.click();
              }
            } else {
              activeMapIndex = indexValue;
              renderCarte();
            }
          });
        });

        const toggleEditingBtn = document.getElementById('toggleMapEditing');
        if (toggleEditingBtn) {
          toggleEditingBtn.addEventListener('click', () => {
            if (mapReplaceMode) {
              mapReplaceMode = false;
              mapReplaceTargetIndex = null;
            }
            mapGalleryEditing = !mapGalleryEditing;
            renderCarte();
          });
        }

        content.querySelectorAll('[data-delete-map]').forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.stopPropagation();
            const index = Number(btn.dataset.deleteMap);
            if (Number.isNaN(index)) return;
            customMapGallery.splice(index, 1);
            if (activeMapIndex >= customMapGallery.length) {
              activeMapIndex = Math.max(customMapGallery.length - 1, 0);
            }
            persistState();
            pushToast('Carte supprimÃ©e.', 'danger');
            renderCarte();
          });
        });
      }

      function handleMapUpload(event) {
        const files = Array.from(event.target.files || []);
        if (!files.length) return;
        const imageFiles = files.filter((file) => file.type.startsWith('image/'));
        if (!imageFiles.length) {
          pushToast('Merci de sÃ©lectionner des images valides.', 'danger');
          event.target.value = '';
          return;
        }
        Promise.all(imageFiles.map((file, idx) => readFileAsDataURL(file).then((dataUrl) => ({ dataUrl, file, idx }))))
          .then((payloads) => {
            const nextEntries = payloads.map(({ dataUrl, file, idx }) => {
              const defaultName = file.name ? file.name.replace(/\.[^.]+$/i, '') || `Carte ${idx + 1}` : `Carte ${idx + 1}`;
              const chosenName = promptMapName(defaultName, file.name || '');
              return normalizeMapEntry({ url: dataUrl, title: chosenName }, idx);
            }).filter(Boolean);
            customMapGallery = [...customMapGallery, ...nextEntries];
            activeMapIndex = customMapGallery.length - 1;
            pushToast(nextEntries.length > 1 ? 'Nouvelles cartes chargÃ©es.' : 'Nouvelle carte chargÃ©e.');
            mapReplaceMode = false;
            mapReplaceTargetIndex = null;
            persistState();
            if (currentSection === 'carte') {
              renderCarte();
            }
          })
          .catch(() => {
            pushToast('Impossible de charger certaines images.', 'danger');
          })
          .finally(() => {
            event.target.value = '';
          });
      }

      function handleMapReplace(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) {
          event.target.value = '';
          return;
        }
        if (!mapReplaceMode || mapReplaceTargetIndex === null || !customMapGallery[mapReplaceTargetIndex]) {
          pushToast('Merci de sÃ©lectionner une carte Ã  modifier.', 'danger');
          event.target.value = '';
          return;
        }
        if (!file.type.startsWith('image/')) {
          pushToast('SÃ©lectionnez une image valide.', 'danger');
          event.target.value = '';
          return;
        }
        readFileAsDataURL(file)
          .then((dataUrl) => {
            const currentEntry = customMapGallery[mapReplaceTargetIndex];
            const defaultName = file.name ? file.name.replace(/\.[^.]+$/i, '') || currentEntry.title : currentEntry.title;
            const chosenName = promptMapName(defaultName, file.name || '') || currentEntry.title;
            customMapGallery[mapReplaceTargetIndex] = {
              ...currentEntry,
              url: dataUrl,
              title: chosenName
            };
            activeMapIndex = mapReplaceTargetIndex;
            pushToast('Carte mise Ã  jour.');
            mapReplaceMode = false;
            mapReplaceTargetIndex = null;
            persistState();
            renderCarte();
          })
          .catch(() => {
            pushToast('Impossible de remplacer cette carte.', 'danger');
          })
          .finally(() => {
            event.target.value = '';
          });
      }

      function openMapFullscreen(url) {
        if (!url) {
          pushToast('Aucune carte Ã  afficher.', 'danger');
          return;
        }
        const win = window.open('', '_blank');
        if (!win) {
          pushToast('Impossible d\'ouvrir la carte. Veuillez autoriser les pop-ups.', 'danger');
          return;
        }
        win.document.write(`<!DOCTYPE html><html lang="fr"><head><title>Carte Obscur 7Wands</title><style>body{margin:0;background:#020617;display:flex;align-items:center;justify-content:center;height:100vh;}img{max-width:100%;max-height:100%;object-fit:contain;}</style></head><body><img src="${url}" alt="Carte Obscur 7Wands" /></body></html>`);
        win.document.close();
      }

      // Dynamically load emoji table to keep HTML small
      const emojiRows = [
        ['ğŸŒ','U+1F30D'],['ğŸŒ','U+1F30E'],['ğŸŒ','U+1F30F'],['ğŸŒ','U+1F310'],['ğŸŒ‘','U+1F311'],['ğŸŒ’','U+1F312'],['ğŸŒ“','U+1F313'],['ğŸŒ”','U+1F314'],['ğŸŒ•','U+1F315'],['ğŸŒ–','U+1F316'],['ğŸŒ—','U+1F317'],['ğŸŒ˜','U+1F318'],['ğŸŒ™','U+1F319'],['ğŸŒš','U+1F31A'],['ğŸŒ›','U+1F31B'],['ğŸŒœ','U+1F31C'],['ğŸŒ','U+1F31D'],['ğŸŒ','U+1F31E'],['ğŸŒŸ','U+1F31F'],['ğŸŒ ','U+1F320'],['ğŸŒ°','U+1F330'],['ğŸŒ±','U+1F331'],['ğŸŒ²','U+1F332'],['ğŸŒ³','U+1F333'],['ğŸŒ´','U+1F334'],['ğŸŒµ','U+1F335'],['ğŸŒ·','U+1F337'],['ğŸŒ¸','U+1F338'],['ğŸŒ¹','U+1F339'],['ğŸŒº','U+1F33A'],['ğŸŒ»','U+1F33B'],['ğŸŒ¼','U+1F33C'],['ğŸŒ½','U+1F33D'],['ğŸŒ¾','U+1F33E'],['ğŸŒ¿','U+1F33F'],['ğŸ€','U+1F340'],['ğŸ','U+1F341'],['ğŸ‚','U+1F342'],['ğŸƒ','U+1F343'],['ğŸ„','U+1F344'],['ğŸ…','U+1F345'],['ğŸ†','U+1F346'],['ğŸ‡','U+1F347'],['ğŸˆ','U+1F348'],['ğŸ‰','U+1F349'],['ğŸŠ','U+1F34A'],['ğŸ‹','U+1F34B'],['ğŸŒ','U+1F34C'],['ğŸ','U+1F34D'],['ğŸ','U+1F34E'],['ğŸ','U+1F34F'],['ğŸ','U+1F350'],['ğŸ‘','U+1F351'],['ğŸ’','U+1F352'],['ğŸ“','U+1F353'],['ğŸ”','U+1F354'],['ğŸ•','U+1F355'],['ğŸ–','U+1F356'],['ğŸ—','U+1F357'],['ğŸ˜','U+1F358'],['ğŸ™','U+1F359'],['ğŸš','U+1F35A'],['ğŸ›','U+1F35B'],['ğŸœ','U+1F35C'],['ğŸ','U+1F35D'],['ğŸ','U+1F35E'],['ğŸŸ','U+1F35F'],['ğŸ ','U+1F360'],['ğŸ¡','U+1F361'],['ğŸ¢','U+1F362'],['ğŸ£','U+1F363'],['ğŸ¤','U+1F364'],['ğŸ¥','U+1F365'],['ğŸ¦','U+1F366'],['ğŸ§','U+1F367'],['ğŸ¨','U+1F368'],['ğŸ©','U+1F369'],['ğŸª','U+1F36A'],['ğŸ«','U+1F36B'],['ğŸ¬','U+1F36C'],['ğŸ­','U+1F36D'],['ğŸ®','U+1F36E'],['ğŸ¯','U+1F36F'],['ğŸ°','U+1F370'],['ğŸ±','U+1F371'],['ğŸ²','U+1F372'],['ğŸ³','U+1F373'],['ğŸ´','U+1F374'],['ğŸµ','U+1F375'],['ğŸ¶','U+1F376'],['ğŸ·','U+1F377'],['ğŸ¸','U+1F378'],['ğŸ¹','U+1F379'],['ğŸº','U+1F37A'],['ğŸ»','U+1F37B'],['ğŸ¼','U+1F37C'],['ğŸ€','U+1F380'],['ğŸ','U+1F381'],['ğŸ‚','U+1F382'],['ğŸƒ','U+1F383'],['ğŸ„','U+1F384'],['ğŸ…','U+1F385'],['ğŸ†','U+1F386'],['ğŸ‡','U+1F387'],['ğŸˆ','U+1F388'],['ğŸ‰','U+1F389'],['ğŸŠ','U+1F38A'],['ğŸ‹','U+1F38B'],['ğŸŒ','U+1F38C'],['ğŸ','U+1F38D'],['ğŸ','U+1F38E'],['ğŸ','U+1F38F'],['ğŸ','U+1F390'],['ğŸ‘','U+1F391'],['ğŸ’','U+1F392'],['ğŸ“','U+1F393'],['ğŸ ','U+1F3A0'],['ğŸ¡','U+1F3A1'],['ğŸ¢','U+1F3A2'],['ğŸ£','U+1F3A3'],['ğŸ¤','U+1F3A4'],['ğŸ¥','U+1F3A5'],['ğŸ¦','U+1F3A6'],['ğŸ§','U+1F3A7'],['ğŸ¨','U+1F3A8'],['ğŸ©','U+1F3A9'],['ğŸª','U+1F3AA'],['ğŸ«','U+1F3AB'],['ğŸ¬','U+1F3AC'],['ğŸ­','U+1F3AD'],['ğŸ®','U+1F3AE'],['ğŸ¯','U+1F3AF'],['ğŸ°','U+1F3B0'],['ğŸ±','U+1F3B1'],['ğŸ²','U+1F3B2'],['ğŸ³','U+1F3B3'],['ğŸ´','U+1F3B4'],['ğŸµ','U+1F3B5'],['ğŸ¶','U+1F3B6'],['ğŸ·','U+1F3B7'],['ğŸ¸','U+1F3B8'],['ğŸ¹','U+1F3B9'],['ğŸº','U+1F3BA'],['ğŸ»','U+1F3BB'],['ğŸ¼','U+1F3BC'],['ğŸ½','U+1F3BD'],['ğŸ¾','U+1F3BE'],['ğŸ¿','U+1F3BF'],['ğŸ€','U+1F3C0'],['ğŸ','U+1F3C1'],['ğŸ‚','U+1F3C2'],['ğŸƒ','U+1F3C3'],['ğŸ„','U+1F3C4'],['ğŸ†','U+1F3C6'],['ğŸ‡','U+1F3C7'],['ğŸˆ','U+1F3C8'],['ğŸ‰','U+1F3C9'],['ğŸŠ','U+1F3CA'],['ğŸ ','U+1F3E0'],['ğŸ¡','U+1F3E1'],['ğŸ¢','U+1F3E2'],['ğŸ£','U+1F3E3'],['ğŸ¤','U+1F3E4'],['ğŸ¥','U+1F3E5'],['ğŸ¦','U+1F3E6'],['ğŸ§','U+1F3E7'],['ğŸ¨','U+1F3E8'],['ğŸ©','U+1F3E9'],['ğŸª','U+1F3EA'],['ğŸ«','U+1F3EB'],['ğŸ¬','U+1F3EC'],['ğŸ­','U+1F3ED'],['ğŸ®','U+1F3EE'],['ğŸ¯','U+1F3EF'],['ğŸ°','U+1F3F0'],['ğŸ€','U+1F400'],['ğŸ','U+1F401'],['ğŸ‚','U+1F402'],['ğŸƒ','U+1F403'],['ğŸ„','U+1F404'],['ğŸ…','U+1F405'],['ğŸ†','U+1F406'],['ğŸ‡','U+1F407'],['ğŸˆ','U+1F408'],['ğŸ‰','U+1F409'],['ğŸŠ','U+1F40A'],['ğŸ‹','U+1F40B'],['ğŸŒ','U+1F40C'],['ğŸ','U+1F40D'],['ğŸ','U+1F40E'],['ğŸ','U+1F40F'],['ğŸ','U+1F410'],['ğŸ‘','U+1F411'],['ğŸ’','U+1F412'],['ğŸ“','U+1F413'],['ğŸ”','U+1F414'],['ğŸ•','U+1F415'],['ğŸ–','U+1F416'],['ğŸ—','U+1F417'],['ğŸ˜','U+1F418'],['ğŸ™','U+1F419'],['ğŸš','U+1F41A'],['ğŸ›','U+1F41B'],['ğŸœ','U+1F41C'],['ğŸ','U+1F41D'],['ğŸ','U+1F41E'],['ğŸŸ','U+1F41F'],['ğŸ ','U+1F420'],['ğŸ¡','U+1F421'],['ğŸ¢','U+1F422'],['ğŸ£','U+1F423'],['ğŸ¤','U+1F424'],['ğŸ¥','U+1F425'],['ğŸ¦','U+1F426'],['ğŸ§','U+1F427'],['ğŸ¨','U+1F428'],['ğŸ©','U+1F429'],['ğŸª','U+1F42A'],['ğŸ«','U+1F42B'],['ğŸ¬','U+1F42C'],['ğŸ­','U+1F42D'],['ğŸ®','U+1F42E'],['ğŸ¯','U+1F42F'],['ğŸ°','U+1F430'],['ğŸ±','U+1F431'],['ğŸ²','U+1F432'],['ğŸ³','U+1F433'],['ğŸ´','U+1F434'],['ğŸµ','U+1F435'],['ğŸ¶','U+1F436'],['ğŸ·','U+1F437'],['ğŸ¸','U+1F438'],['ğŸ¹','U+1F439'],['ğŸº','U+1F43A'],['ğŸ»','U+1F43B'],['ğŸ¼','U+1F43C'],['ğŸ½','U+1F43D'],['ğŸ¾','U+1F43E'],['ğŸ‘€','U+1F440'],['ğŸ‘‚','U+1F442'],['ğŸ‘ƒ','U+1F443'],['ğŸ‘„','U+1F444'],['ğŸ‘…','U+1F445'],['ğŸ‘†','U+1F446'],['ğŸ‘‡','U+1F447'],['ğŸ‘ˆ','U+1F448'],['ğŸ‘‰','U+1F449'],['ğŸ‘Š','U+1F44A'],['ğŸ‘‹','U+1F44B'],['ğŸ‘Œ','U+1F44C'],['ğŸ‘','U+1F44D'],['ğŸ‘','U+1F44E'],['ğŸ‘','U+1F44F'],['ğŸ‘','U+1F450'],['ğŸ‘‘','U+1F451'],['ğŸ‘’','U+1F452'],['ğŸ‘“','U+1F453'],['ğŸ‘”','U+1F454'],['ğŸ‘•','U+1F455'],['ğŸ‘–','U+1F456'],['ğŸ‘—','U+1F457'],['ğŸ‘˜','U+1F458'],['ğŸ‘™','U+1F459'],['ğŸ‘š','U+1F45A'],['ğŸ‘›','U+1F45B'],['ğŸ‘œ','U+1F45C'],['ğŸ‘','U+1F45D'],['ğŸ‘','U+1F45E'],['ğŸ‘Ÿ','U+1F45F'],['ğŸ‘ ','U+1F460'],['ğŸ‘¡','U+1F461'],['ğŸ‘¢','U+1F462'],['ğŸ‘£','U+1F463'],['ğŸ‘¤','U+1F464'],['ğŸ‘¥','U+1F465'],['ğŸ‘¦','U+1F466'],['ğŸ‘§','U+1F467'],['ğŸ‘¨','U+1F468'],['ğŸ‘©','U+1F469'],['ğŸ‘ª','U+1F46A'],['ğŸ‘«','U+1F46B'],['ğŸ‘¬','U+1F46C'],['ğŸ‘­','U+1F46D'],['ğŸ‘®','U+1F46E'],['ğŸ‘¯','U+1F46F'],['ğŸ‘°','U+1F470'],['ğŸ‘±','U+1F471'],['ğŸ‘²','U+1F472'],['ğŸ‘³','U+1F473'],['ğŸ‘´','U+1F474'],['ğŸ‘µ','U+1F475'],['ğŸ‘¶','U+1F476'],['ğŸ‘·','U+1F477'],['ğŸ‘¸','U+1F478'],['ğŸ‘¹','U+1F479'],['ğŸ‘º','U+1F47A'],['ğŸ‘»','U+1F47B'],['ğŸ‘¼','U+1F47C'],['ğŸ‘½','U+1F47D'],['ğŸ‘¾','U+1F47E'],['ğŸ‘¿','U+1F47F'],['ğŸ’€','U+1F480'],['ğŸ’','U+1F481'],['ğŸ’‚','U+1F482'],['ğŸ’ƒ','U+1F483'],['ğŸ’„','U+1F484'],['ğŸ’…','U+1F485'],['ğŸ’†','U+1F486'],['ğŸ’‡','U+1F487'],['ğŸ’ˆ','U+1F488'],['ğŸ’‰','U+1F489'],['ğŸ’Š','U+1F48A'],['ğŸ’‹','U+1F48B'],['ğŸ’Œ','U+1F48C'],['ğŸ’','U+1F48D'],['ğŸ’','U+1F48E'],['ğŸ’','U+1F48F'],['ğŸ’','U+1F490'],['ğŸ’‘','U+1F491'],['ğŸ’’','U+1F492'],['ğŸ’“','U+1F493'],['ğŸ’”','U+1F494'],['ğŸ’•','U+1F495'],['ğŸ’–','U+1F496'],['ğŸ’—','U+1F497'],['ğŸ’˜','U+1F498'],['ğŸ’™','U+1F499'],['ğŸ’š','U+1F49A'],['ğŸ’›','U+1F49B'],['ğŸ’œ','U+1F49C'],['ğŸ’','U+1F49D'],['ğŸ’','U+1F49E'],['ğŸ’Ÿ','U+1F49F'],['ğŸ’¡','U+1F4A1'],['ğŸ’¢','U+1F4A2'],['ğŸ’£','U+1F4A3'],['ğŸ’¤','U+1F4A4'],['ğŸ’¥','U+1F4A5'],['ğŸ’¦','U+1F4A6'],['ğŸ’§','U+1F4A7'],['ğŸ’¨','U+1F4A8'],['ğŸ’©','U+1F4A9'],['ğŸ’ª','U+1F4AA'],['ğŸ’«','U+1F4AB'],['ğŸ’¬','U+1F4AC'],['ğŸ’­','U+1F4AD'],['ğŸ’®','U+1F4AE'],['ğŸ’¯','U+1F4AF'],['ğŸ’°','U+1F4B0'],['ğŸ’±','U+1F4B1'],['ğŸ’²','U+1F4B2'],['ğŸ’³','U+1F4B3'],['ğŸ’´','U+1F4B4'],['ğŸ’µ','U+1F4B5'],['ğŸ’¶','U+1F4B6'],['ğŸ’·','U+1F4B7'],['ğŸ’¸','U+1F4B8'],['ğŸ’¹','U+1F4B9'],['ğŸ’»','U+1F4BB'],['ğŸ’¼','U+1F4BC'],['ğŸ’½','U+1F4BD'],['ğŸ’¾','U+1F4BE'],['ğŸ’¿','U+1F4BF'],['ğŸ“€','U+1F4C0'],['ğŸ“','U+1F4C1'],['ğŸ“‚','U+1F4C2'],['ğŸ“ƒ','U+1F4C3'],['ğŸ“„','U+1F4C4'],['ğŸ“…','U+1F4C5'],['ğŸ“†','U+1F4C6'],['ğŸ“‡','U+1F4C7'],['ğŸ“ˆ','U+1F4C8'],['ğŸ“‰','U+1F4C9'],['ğŸ“Š','U+1F4CA'],['ğŸ“‹','U+1F4CB'],['ğŸ“Œ','U+1F4CC'],['ğŸ“','U+1F4CD'],['ğŸ“','U+1F4CE'],['ğŸ“','U+1F4CF'],['ğŸ“','U+1F4D0'],['ğŸ“‘','U+1F4D1'],['ğŸ“’','U+1F4D2'],['ğŸ““','U+1F4D3'],['ğŸ“”','U+1F4D4'],['ğŸ“•','U+1F4D5'],['ğŸ“–','U+1F4D6'],['ğŸ“—','U+1F4D7'],['ğŸ“˜','U+1F4D8'],['ğŸ“™','U+1F4D9'],['ğŸ“š','U+1F4DA'],['ğŸ“›','U+1F4DB'],['ğŸ“œ','U+1F4DC'],['ğŸ“','U+1F4DD'],['ğŸ“','U+1F4DE'],['ğŸ“Ÿ','U+1F4DF'],['ğŸ“ ','U+1F4E0'],['ğŸ“¡','U+1F4E1'],['ğŸ“¢','U+1F4E2'],['ğŸ“£','U+1F4E3'],['ğŸ“¤','U+1F4E4'],['ğŸ“¥','U+1F4E5'],['ğŸ“¦','U+1F4E6'],['ğŸ“§','U+1F4E7'],['ğŸ“¨','U+1F4E8'],['ğŸ“©','U+1F4E9'],['ğŸ“ª','U+1F4EA'],['ğŸ“«','U+1F4EB'],['ğŸ“¬','U+1F4EC'],['ğŸ“­','U+1F4ED'],['ğŸ“®','U+1F4EE'],['ğŸ“¯','U+1F4EF'],['ğŸ“°','U+1F4F0'],['ğŸ“±','U+1F4F1'],['ğŸ“²','U+1F4F2'],['ğŸ“³','U+1F4F3'],['ğŸ“´','U+1F4F4'],['ğŸ“µ','U+1F4F5'],['ğŸ“¶','U+1F4F6'],['ğŸ“·','U+1F4F7'],['ğŸ“¹','U+1F4F9'],['ğŸ“º','U+1F4FA'],['ğŸ“»','U+1F4FB'],['ğŸ“¼','U+1F4FC'],['ğŸ”Š','U+1F50A'],['ğŸ“¢','U+1F4E2'],['ğŸ“£','U+1F4E3'],['ğŸ”‹','U+1F50B'],['ğŸ”Œ','U+1F50C'],['ğŸ”','U+1F50D'],['ğŸ”','U+1F50E'],['ğŸ”','U+1F50F'],['ğŸ”','U+1F510'],['ğŸ”‘','U+1F511'],['ğŸ”’','U+1F512'],['ğŸ”“','U+1F513'],['ğŸ””','U+1F514'],['ğŸ”•','U+1F515'],['ğŸ”–','U+1F516'],['ğŸ”—','U+1F517'],['ğŸ”˜','U+1F518'],['ğŸ”™','U+1F519'],['ğŸ”š','U+1F51A'],['ğŸ”›','U+1F51B'],['ğŸ”œ','U+1F51C'],['ğŸ”','U+1F51D'],['ğŸ”','U+1F51E'],['ğŸ”Ÿ','U+1F51F'],['ğŸ” ','U+1F520'],['ğŸ”¡','U+1F521'],['ğŸ”¢','U+1F522'],['ğŸ”£','U+1F523'],['ğŸ”¤','U+1F524'],['ğŸ”¥','U+1F525'],['ğŸ”¦','U+1F526'],['ğŸ”§','U+1F527'],['ğŸ”§','U+1F527'],['ğŸ”¨','U+1F528'],['ğŸ”©','U+1F529'],['ğŸ”ª','U+1F52A'],['ğŸ”«','U+1F52B'],['ğŸ”®','U+1F52E'],['ğŸ”¯','U+1F52F'],['ğŸ”°','U+1F530'],['ğŸ”±','U+1F531'],['ğŸ”²','U+1F532'],['ğŸ”³','U+1F533'],['ğŸ”´','U+1F534'],['ğŸ”µ','U+1F535'],['ğŸ”¶','U+1F536'],['ğŸ”·','U+1F537'],['ğŸ”¸','U+1F538'],['ğŸ”¹','U+1F539'],['ğŸ”º','U+1F53A'],['ğŸ”»','U+1F53B'],['ğŸ”¼','U+1F53C'],['ğŸ”½','U+1F53D'],['ğŸ•','U+1F550'],['ğŸ•‘','U+1F551'],['ğŸ•’','U+1F552'],['ğŸ•“','U+1F553'],['ğŸ•”','U+1F554'],['ğŸ••','U+1F555'],['ğŸ•–','U+1F556'],['ğŸ•—','U+1F557'],['ğŸ•˜','U+1F558'],['ğŸ•™','U+1F559'],['ğŸ•š','U+1F55A'],['ğŸ•›','U+1F55B'],['ğŸ—»','U+1F5FB'],['ğŸ—¼','U+1F5FC'],['ğŸ—½','U+1F5FD'],['ğŸ—¾','U+1F5FE'],['ğŸ—¿','U+1F5FF']
      ];

      function populateEmojiTable() {
        const body = document.getElementById('emojiTableBody');
        if (!body) return;
        body.innerHTML = emojiRows.map(([emoji, code]) => `<tr><td class="text-2xl">${emoji}</td><td>${code}</td></tr>`).join('');
      }

      function toggleEmojiOverlay(show) {
        const overlay = document.getElementById('emojiOverlay');
        if (!overlay) return;
        overlay.classList.toggle('is-visible', show);
        if (show) populateEmojiTable();
      }

      function renderCategory(key) {
        const meta = bookMeta[key];
        const items = library[key] || [];
        const isEditing = !!editingState[key];
        const showEditTips = sectionsWithEditTips.has(key);
        const formatCountLabel = (count) => `${count} Ã©lÃ©ment${count > 1 ? 's' : ''}`;
        const chipList = items.length
          ? items.map((item) => `<span class="rounded-full border border-white/20 bg-white/10 px-3 py-1 text-xs text-white/90">${getDisplayTitle(item)}</span>`).join(' ')
          : '<span class="rounded-full border border-dashed border-white/20 px-3 py-1 text-xs text-white/80">Aucun Ã©lÃ©ment pour lâ€™instant</span>';

        const createItemCard = (item) => {
          const isRecipeCategory = ingredientCategories.has(key);
          const contentLabel = key === 'recettes-potions' ? 'Instructions' : key === 'creatures' ? 'Informations' : isRecipeCategory ? 'Information' : 'DÃ©tails';
          const effectsTeaser = key === 'recettes-potions' && item.effects
            ? `<p class="mt-1 text-xs text-cyan-100/80">${escapeHtml(createExcerpt(item.effects, 90))}</p>`
            : '';
          const ingredientsBlock = isRecipeCategory && item.ingredients
            ? `<div>
                  <p class="text-xs uppercase tracking-[0.2em] text-emerald-200">IngrÃ©dients</p>
                  <p class="text-sm text-white/90">${formatMultiline(item.ingredients)}</p>
                </div>`
            : '';
          const effectsBlock = key === 'recettes-potions' && item.effects
            ? `<div>
                  <p class="text-xs uppercase tracking-[0.2em] text-cyan-200">Effets</p>
                  <p class="text-sm text-white/90">${formatMultiline(item.effects)}</p>
                </div>`
            : '';
          const incantationBlock = key === 'recettes-potions' && item.incantation
            ? `<div>
                  <p class="text-xs uppercase tracking-[0.2em] text-purple-200">Incantation</p>
                  <p class="text-sm text-white/90">${formatMultiline(item.incantation)}</p>
                </div>`
            : '';
          const creatureBlocks = key === 'creatures'
            ? (() => {
                const pieces = [];
                if (item.danger) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-red-200">DangerositÃ©</p><p class="text-sm text-white/90">${escapeHtml(item.danger)}</p>`);
                }
                if (item.size || item.sex || item.weight) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-amber-200">Mensurations</p><p class="text-sm text-white/90">${[item.size, item.sex, item.weight].filter(Boolean).map(escapeHtml).join(' Â· ')}</p>`);
                }
                if (item.physical) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-emerald-200">CaractÃ©ristiques physiques</p><p class="text-sm text-white/90">${formatMultiline(item.physical)}</p>`);
                }
                if (item.habitat) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-lime-200">Lieu de vie</p><p class="text-sm text-white/90">${formatMultiline(item.habitat)}</p>`);
                }
                if (item.info) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-white/70">Informations supplÃ©mentaires</p><p class="text-sm text-white/90">${formatMultiline(item.info)}</p>`);
                }
                if (item.content) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-white/70">${contentLabel}</p><p class="text-sm text-white/90">${formatMultiline(item.content)}</p>`);
                }
                if (item.photo) {
                  pieces.push(`<div class="mt-2"><img src="${item.photo}" alt="${escapeHtml(item.title || 'CrÃ©ature')}" class="mt-2 w-full rounded-xl border border-white/20 object-cover" /></div>`);
                }
                return pieces.length ? `<div class="space-y-2">${pieces.map((piece) => `<div>${piece}</div>`).join('')}</div>` : '';
              })()
            : '';
          const matchedMap = key === 'ingredients' ? findMapByTitle(item.location || '') : null;
          const locationBlock = key === 'ingredients' && item.location
            ? `<div>
                  <p class="text-xs uppercase tracking-[0.2em] text-lime-200">Emplacement</p>
                  <p class="text-sm text-white/90">${matchedMap
                    ? `<button type="button" class="map-location-link underline decoration-dotted decoration-lime-200/60 hover:text-lime-100" data-map-location-url="${matchedMap.url}" data-map-location-title="${escapeHtml(matchedMap.title)}">${escapeHtml(matchedMap.title)}</button>`
                    : formatMultiline(item.location)}</p>
                </div>`
            : '';
          const contentBlock = item.content && key !== 'creatures'
            ? `<div>
                  <p class="text-xs uppercase tracking-[0.2em] text-white/70">${contentLabel}</p>
                  <p class="text-sm text-white/90">${formatMultiline(item.content)}</p>
                </div>`
            : '';
          const botaniqueBlocks = key === 'botanique'
            ? (() => {
                const pieces = [];
                if (item.danger) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-red-200">DangerositÃ©</p><p class="text-sm text-white/90">${escapeHtml(item.danger)}</p>`);
                }
                if (item.size) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-amber-200">Taille</p><p class="text-sm text-white/90">${escapeHtml(item.size)}</p>`);
                }
                if (item.physical) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-emerald-200">CaractÃ©ristiques</p><p class="text-sm text-white/90">${formatMultiline(item.physical)}</p>`);
                }
                if (item.habitat) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-lime-200">Lieu de vie</p><p class="text-sm text-white/90">${formatMultiline(item.habitat)}</p>`);
                }
                if (item.info) {
                  pieces.push(`<p class="text-xs uppercase tracking-[0.2em] text-white/70">Informations supplÃ©mentaires</p><p class="text-sm text-white/90">${formatMultiline(item.info)}</p>`);
                }
                if (item.photo) {
                  pieces.push(`<div class="mt-2"><img src="${item.photo}" alt="${escapeHtml(item.title || 'Plante')}" class="mt-2 w-full rounded-xl border border-white/20 object-cover" /></div>`);
                }
                return pieces.length ? `<div class="space-y-2">${pieces.map((piece) => `<div>${piece}</div>`).join('')}</div>` : '';
              })()
            : '';
          const detailBlocks = [];
          if (key === 'recettes-potions') {
            if (effectsBlock) detailBlocks.push(effectsBlock);
            if (ingredientsBlock) detailBlocks.push(ingredientsBlock);
            if (contentBlock) detailBlocks.push(contentBlock);
            if (incantationBlock) detailBlocks.push(incantationBlock);
          } else if (key === 'creatures') {
            if (creatureBlocks) detailBlocks.push(creatureBlocks);
          } else if (key === 'botanique') {
            if (botaniqueBlocks) detailBlocks.push(botaniqueBlocks);
          } else {
            if (ingredientsBlock) detailBlocks.push(ingredientsBlock);
            if (contentBlock) detailBlocks.push(contentBlock);
            if (locationBlock) detailBlocks.push(locationBlock);
            if (incantationBlock) detailBlocks.push(incantationBlock);
          }
          const detailsMarkup = detailBlocks.join('');
          return `
              <li data-id="${item.id}" data-expanded="false" class="module-surface item-card group cursor-pointer rounded-2xl border border-white/10 p-4 transition hover:-translate-y-0.5 hover:border-cyan-200/60" draggable="${isEditing}">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <h4 class="mt-0 text-lg font-semibold text-white">${getDisplayTitle(item)}</h4>
                    ${key === 'recettes-potions' ? effectsTeaser : ''}
                    ${key === 'cours' && item.professor ? `<p class="text-xs uppercase tracking-[0.2em] text-emerald-200">${escapeHtml(item.professor)}</p>` : ''}
                    ${key === 'creatures' && item.danger ? `<p class="text-xs uppercase tracking-[0.4em] text-red-200">${escapeHtml(item.danger)}</p>` : ''}
                  </div>
                  <button type="button" class="edit-item rounded-full border border-white/30 px-3 py-1 text-xs font-semibold text-white/80 transition hover:border-cyan-300 hover:text-white">Ã‰diter</button>
                </div>
                <div class="item-details mt-3 space-y-2 hidden">
                  ${detailsMarkup}
                </div>
                <button type="button" class="delete-item" aria-label="Supprimer ${escapeHtml(item.title)}">âœ•</button>
              </li>`;
        };

        const listMarkup = items.length
          ? items.map((item) => createItemCard(item)).join('')
          : '<li class="module-surface rounded-2xl border border-dashed border-white/20 p-6 text-center text-white/90">Ajoutez votre premier Ã©lÃ©ment pour commencer.</li>';

        const inventoryLabelMap = {
          'recettes-cuisines': 'Liste des Recettes',
          'recettes-potions': 'Liste des Potions',
          'cours': 'Notes sur les Cours',
          'creatures': 'Bestiaire vivant',
          'ingredients': 'Liste des Ingredients',
          'botanique': 'Herbier Botanique',
          'notes': 'Liste des Notes'
        };
        const inventoryLabel = inventoryLabelMap[key] || 'Inventaire';

        const ingredientColumnsMarkup = key === 'ingredients'
          ? (() => {
              const emptyColumn = '<li class="rounded-2xl border border-dashed border-white/20 p-4 text-center text-white/80">Ajoutez votre premier ingrÃ©dient.</li>';
              const cuisineItems = items.filter((item) => (item.usage || 'cuisine') === 'cuisine');
              const potionItems = items.filter((item) => (item.usage || 'cuisine') === 'potion');
              const cuisineMarkup = cuisineItems.length ? cuisineItems.map((item) => createItemCard(item)).join('') : emptyColumn;
              const potionMarkup = potionItems.length ? potionItems.map((item) => createItemCard(item)).join('') : emptyColumn;
              return `
                <div class="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-2">
                  <div class="rounded-2xl border border-white/15 bg-white/5 p-4">
                    <p class="text-sm font-semibold text-white">IngrÃ©dients Cuisine</p>
                    <p class="text-xs uppercase tracking-[0.4em] text-white/80 mt-1">${formatCountLabel(cuisineItems.length)}</p>
                    <ul data-item-list data-usage="cuisine" class="mt-3 space-y-3${isEditing ? ' list-editing' : ''}">
                      ${cuisineMarkup}
                    </ul>
                  </div>
                  <div class="rounded-2xl border border-white/15 bg-white/5 p-4">
                    <p class="text-sm font-semibold text-white">IngrÃ©dients Potion</p>
                    <p class="text-xs uppercase tracking-[0.4em] text-white/80 mt-1">${formatCountLabel(potionItems.length)}</p>
                    <ul data-item-list data-usage="potion" class="mt-3 space-y-3${isEditing ? ' list-editing' : ''}">
                      ${potionMarkup}
                    </ul>
                  </div>
                </div>`;
            })()
          : '';

        const potionColumnsMarkup = key === 'recettes-potions'
          ? (() => {
              const empty = '<li class="rounded-2xl border border-dashed border-white/20 p-4 text-center text-white/80">Ajoutez votre premiÃ¨re potion.</li>';
              const byClass = (cls) => items.filter((item) => (item.classification || 'normale') === cls);
              const renderCol = (title, cls) => {
                const colItems = byClass(cls);
                const markup = colItems.length ? colItems.map((item) => createItemCard(item)).join('') : empty;
                return `
                  <div class="rounded-2xl border border-white/15 bg-white/5 p-4">
                    <p class="text-sm font-semibold text-white">${title}</p>
                    <p class="text-xs uppercase tracking-[0.4em] text-white/80 mt-1">${formatCountLabel(colItems.length)}</p>
                    <ul data-item-list data-classification="${cls}" class="mt-3 space-y-3${isEditing ? ' list-editing' : ''}">${markup}</ul>
                  </div>`;
              };
              return `
                <div class="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-2">
                  ${renderCol('Naniss', 'naniss')}
                  ${renderCol('Normale', 'normale')}
                  ${renderCol('Grande', 'grande')}
                  ${renderCol('Mega', 'mega')}
                </div>`;
            })()
          : '';

        content.innerHTML = `
          <section class="space-y-8 animate-fade">
            <div class="module-surface rounded-3xl border border-white/10 p-8 shadow-2xl shadow-black/40">
              <h2 class="text-3xl font-bold text-white">${meta.label}</h2>
              <div class="mt-4 flex flex-wrap gap-2 text-xs" id="chipList">${chipList}</div>
              <button id="addItem" class="mt-6 inline-flex items-center gap-2 rounded-full border border-white/40 bg-white/10 px-6 py-2 text-sm font-semibold text-white transition hover:bg-white/20">+ Ajouter un Ã©lÃ©ment</button>
            </div>
            <div class="module-surface rounded-2xl border border-white/10 p-6 backdrop-blur">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                  <h3 class="text-2xl font-semibold text-white">${inventoryLabel}</h3>
                  <p class="mt-1 text-xs uppercase tracking-[0.4em] text-white/80">${formatCountLabel(items.length)}</p>
                </div>
                ${showEditTips
                  ? `<div class="flex flex-col items-end gap-2 text-right">
                      <button type="button" id="toggleEditing" class="text-xs font-semibold text-white/80 underline-offset-4 hover:text-white">${isEditing ? 'Terminer les modifications' : 'Cliquez pour modifier'}</button>
                      <div class="text-xs text-white/80 ${isEditing ? '' : 'hidden'}" id="editTips">
                        <p>Cliquez sur la croix rouge pour supprimÃ©</p>
                        <p class="mt-1">Restez clique sur la section pour la dÃ©placer</p>
                      </div>
                    </div>`
                  : `<button type="button" id="toggleEditing" class="text-xs font-semibold text-white/80 underline-offset-4 hover:text-white">${isEditing ? 'Terminer les modifications' : 'Cliquez pour modifier'}</button>`}
              </div>
              ${key === 'ingredients'
                ? ingredientColumnsMarkup
                : key === 'recettes-potions'
                  ? potionColumnsMarkup
                  : `<ul id="itemList" class="mt-4 space-y-3${isEditing ? ' list-editing' : ''}">${listMarkup}</ul>`}
            </div>
          </section>`;

        document.getElementById('addItem').addEventListener('click', () => openEditor(key));
        enableItemListInteractions(key);
      }

      function openEditor(key, id) {
        closeEditor();
        const isNew = !id;
        const item = isNew
          ? {
              title: '',
              content: '',
              ingredients: '',
              professor: '',
              effects: '',
              incantation: '',
              location: '',
              usage: 'cuisine',
              classification: 'normale',
              emoteCode: '',
              emote: '',
              danger: '',
              size: '',
              sex: '',
              weight: '',
              physical: '',
              habitat: '',
              info: '',
              photo: ''
            }
          : (library[key] || []).find((entry) => entry.id === id);
        const isRecipe = ingredientCategories.has(key);
        const isPotion = key === 'recettes-potions';
        const isCreature = key === 'creatures';
        const isBotanique = key === 'botanique';
        document.body.classList.add('overflow-hidden');
        const titleLabel = isRecipe
          ? 'Nom de la recette'
          : isCreature
            ? 'Nom de la crÃ©ature'
            : isBotanique
              ? 'Nom de la Plante ou Arbre'
              : key === 'cours'
                ? 'Cours'
                : 'Titre';
        const titlePlaceholder = isRecipe
          ? 'Nom captivant de la recette'
          : isCreature
            ? 'Nom de la crÃ©ature'
            : isBotanique
              ? 'Nom de la plante ou de lâ€™arbre'
              : key === 'cours'
                ? 'Titre du cours'
                : 'Nom captivant';
        const contentLabel = isRecipe
          ? (key === 'recettes-potions' ? 'Instructions' : 'Information')
          : isCreature
            ? 'Informations gÃ©nÃ©rales'
            : isBotanique
              ? 'Description dÃ©taillÃ©e'
              : key === 'cours'
                ? 'Note sur le Cours'
                : 'Description dÃ©taillÃ©e';
        const potionClassifications = ['naniss', 'normale', 'grande', 'mega'];
        const contentPlaceholder = isRecipe
          ? (key === 'recettes-potions' ? 'DÃ©roulÃ©, incantations, observations (facultatif)' : 'Ã‰tapes, notes, observations (facultatif)')
          : isCreature
            ? 'Notes complÃ©mentaires sur la crÃ©ature'
            : isBotanique
              ? 'Notes complÃ©mentaires sur la plante ou lâ€™arbre'
              : key === 'cours'
                ? 'Consignes, objectifs, dÃ©tails du cours'
                : 'IngrÃ©dients, Ã©tapes, objectifsâ€¦';

        const overlay = document.createElement('div');
        overlay.id = 'editorOverlay';
        overlay.className = 'editor-overlay';
        overlay.innerHTML = `
          <div class="editor-panel module-surface border border-white/10 p-6 shadow-2xl shadow-black/40">
            <div>
              <p class="text-xs uppercase tracking-[0.4em] text-white/80">${isNew ? 'CrÃ©ation' : 'Ã‰dition'}</p>
              <h3 class="mt-1 text-2xl font-semibold text-white">${isNew ? 'Nouvel Ã©lÃ©ment' : escapeHtml(item?.title || '')}</h3>
            </div>
            <div class="mt-6 grid gap-4 md:grid-cols-2">
              <label class="block text-sm font-medium text-white/90">
                ${titleLabel}
                <input id="itemTitle" type="text" value="${escapeHtml(item?.title || '')}" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="${titlePlaceholder}" />
              </label>
              <label class="block text-sm font-medium text-white/90">
                Code emote (Unicode)
                <input id="itemEmoteCode" type="text" value="${escapeHtml(item?.emoteCode || '')}" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Ex: U+1F40D ou ğŸ" />
                <p class="mt-1 text-[11px] text-white/70">Astuce: saisissez un emoji ou un code Unicode (ex: U+1F31F).</p>
              </label>
            </div>
            ${key === 'recettes-potions' ? `
            <label class="mt-4 block text-sm font-medium text-white/90">
              Effets
              <textarea id="itemEffects" rows="3" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Impact, usage et rÃ©sonance de la potion">${escapeHtml(item?.effects || '')}</textarea>
            </label>` : ''}
            ${key === 'cours' ? `
            <label class="mt-4 block text-sm font-medium text-white/90">
              Professeur
              <input id="itemProfessor" type="text" value="${escapeHtml(item?.professor || '')}" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Nom du professeur" />
            </label>` : ''}
            ${isRecipe ? `
            <label class="mt-4 block text-sm font-medium text-white/90">
              IngrÃ©dients
              <textarea id="itemIngredients" rows="4" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-3 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Liste des composants essentiels">${escapeHtml(item?.ingredients || '')}</textarea>
            </label>` : ''}
            ${isPotion ? `
            <label class="mt-4 block text-sm font-medium text-white/90">
              Classification
              <select id="itemClassification" class="mt-2 w-full rounded-2xl border border-white/30 bg-white px-4 py-2 text-slate-900 focus:border-cyan-300 focus:outline-none">
                <option value="naniss" ${(!item?.classification || item?.classification === 'naniss') ? 'selected' : ''}>Naniss</option>
                <option value="normale" ${(item?.classification === 'normale') ? 'selected' : ''}>Normale</option>
                <option value="grande" ${(item?.classification === 'grande') ? 'selected' : ''}>Grande</option>
                <option value="mega" ${(item?.classification === 'mega') ? 'selected' : ''}>Mega</option>
              </select>
            </label>` : ''}
            <label class="mt-4 block text-sm font-medium text-white/90">
              ${contentLabel}
              <textarea id="itemContent" rows="6" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-3 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="${contentPlaceholder}">${escapeHtml(item?.content || '')}</textarea>
            </label>
            ${(isCreature || isBotanique) ? `
            <div class="mt-4 grid gap-4 md:grid-cols-2">
              <label class="block text-sm font-medium text-white/90">
                DangerositÃ©
                <select id="itemDanger" class="mt-2 w-full rounded-2xl border border-white/30 bg-white px-4 py-2 text-slate-900 focus:border-cyan-300 focus:outline-none">
                  <option value="">Choisir</option>
                  <option value="1ğŸŒŸ" ${item?.danger === '1ğŸŒŸ' ? 'selected' : ''}>1ğŸŒŸ</option>
                  <option value="2ğŸŒŸ" ${item?.danger === '2ğŸŒŸ' ? 'selected' : ''}>2ğŸŒŸ</option>
                  <option value="3ğŸŒŸ" ${item?.danger === '3ğŸŒŸ' ? 'selected' : ''}>3ğŸŒŸ</option>
                  <option value="4ğŸŒŸ" ${item?.danger === '4ğŸŒŸ' ? 'selected' : ''}>4ğŸŒŸ</option>
                  <option value="5ğŸŒŸ" ${item?.danger === '5ğŸŒŸ' ? 'selected' : ''}>5ğŸŒŸ</option>
                  <option value="6ğŸŒŸ" ${item?.danger === '6ğŸŒŸ' ? 'selected' : ''}>6ğŸŒŸ</option>
                </select>
              </label>
              <label class="block text-sm font-medium text-white/90">
                Taille
                <input id="itemSize" type="text" value="${escapeHtml(item?.size || '')}" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Ex: 2 m au garrot" />
              </label>
              ${isCreature ? `
              <label class="block text-sm font-medium text-white/90">
                Sexe
                <select id="itemSex" class="mt-2 w-full rounded-2xl border border-white/30 bg-white px-4 py-2 text-slate-900 focus:border-cyan-300 focus:outline-none">
                  <option value="">Choisir</option>
                  <option value="Seulement MÃ¢le" ${item?.sex === 'Seulement MÃ¢le' ? 'selected' : ''}>Seulement MÃ¢le</option>
                  <option value="Seulement Femelle" ${item?.sex === 'Seulement Femelle' ? 'selected' : ''}>Seulement Femelle</option>
                  <option value="Les deux" ${item?.sex === 'Les deux' ? 'selected' : ''}>Les deux</option>
                </select>
              </label>
              <label class="block text-sm font-medium text-white/90">
                Poids
                <input id="itemWeight" type="text" value="${escapeHtml(item?.weight || '')}" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Ex: 120 kg" />
              </label>
              ` : ''}
            </div>
            <label class="mt-4 block text-sm font-medium text-white/90">
              CaractÃ©ristique
              <textarea id="itemPhysical" rows="3" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Pelage, crocs, ailes, feuillage, Ã©pines, etc.">${escapeHtml(item?.physical || '')}</textarea>
            </label>
            <label class="mt-4 block text-sm font-medium text-white/90">
              Lieu de vie
              <input id="itemHabitat" type="text" value="${escapeHtml(item?.habitat || '')}" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="ForÃªts prismatiques, marÃ©cages, grottes..." />
            </label>
            <label class="mt-4 block text-sm font-medium text-white/90">
              Informations supplÃ©mentaires
              <textarea id="itemInfo" rows="3" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Comportement, faiblesses, anecdotes, vertus">${escapeHtml(item?.info || '')}</textarea>
            </label>
            <label class="mt-4 block text-sm font-medium text-white/90">
              Photo
              <input id="itemPhoto" type="text" value="${escapeHtml(item?.photo || '')}" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="URL de l'image de la crÃ©ature ou de la plante" />
            </label>
            ` : ''}
            ${key === 'ingredients' ? `
            <label class="mt-4 block text-sm font-medium text-white/90">
              Utilisation
              <select id="itemUsage" class="mt-2 w-full rounded-2xl border border-white/30 bg-white px-4 py-2 text-slate-900 focus:border-cyan-300 focus:outline-none">
                <option value="cuisine" ${(!item?.usage || item?.usage === 'cuisine') ? 'selected' : ''}>IngrÃ©dient Cuisine</option>
                <option value="potion" ${(item?.usage === 'potion') ? 'selected' : ''}>IngrÃ©dients Potion</option>
              </select>
            </label>
            <label class="mt-4 block text-sm font-medium text-white/90">
              Emplacement
              <input id="itemLocation" type="text" value="${escapeHtml(item?.location || '')}" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Indiquez un lieu ou laissez vide pour choisir une carte" />
            </label>
            <label class="mt-4 block text-sm font-medium text-white/90">
              SÃ©lectionner depuis les cartes
              <select id="itemLocationSelect" class="mt-2 w-full rounded-2xl border border-white/30 bg-white px-4 py-2 text-slate-900 focus:border-cyan-300 focus:outline-none">
                <option value="">Aucune carte sÃ©lectionnÃ©e</option>
                ${customMapGallery.map((map) => `<option value="${escapeHtml(map.title)}" ${item?.location === map.title ? 'selected' : ''}>${escapeHtml(map.title)}</option>`).join('')}
              </select>
            </label>` : ''}
            ${key === 'recettes-potions' ? `
            <label class="mt-4 block text-sm font-medium text-white/90">
              Incantation
              <textarea id="itemIncantation" rows="3" class="mt-2 w-full rounded-2xl border border-white/30 bg-white/10 px-4 py-2 text-white placeholder-white/60 focus:border-cyan-300 focus:outline-none" placeholder="Formule verbale ou gestuelle">${escapeHtml(item?.incantation || '')}</textarea>
            </label>` : ''}
            <div class="mt-6 flex flex-wrap gap-3">
              <button id="saveItem" class="inline-flex items-center gap-2 rounded-full bg-cyan-200 px-6 py-2 font-semibold text-slate-900 transition hover:bg-cyan-100">${isNew ? 'Enregistrer' : 'Mettre Ã  jour'}</button>
              ${!isNew ? '<button id="deleteItem" class="inline-flex items-center gap-2 rounded-full border border-red-400/60 bg-red-500/10 px-5 py-2 text-red-100 transition hover:bg-red-500/20">Effacer</button>' : ''}
              <button id="cancelEdit" class="inline-flex items-center gap-2 rounded-full border border-white/40 px-5 py-2 text-white transition hover:border-white/70">Fermer</button>
            </div>
          </div>`;

        document.body.appendChild(overlay);

        const stopProp = overlay.querySelector('.editor-panel');
        if (stopProp) {
          stopProp.addEventListener('click', (event) => event.stopPropagation());
        }

        overlay.addEventListener('click', closeEditor);
        document.getElementById('saveItem').addEventListener('click', () => saveItem(key, id));
        const deleteBtn = document.getElementById('deleteItem');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deleteItem(key, id));
        }
        document.getElementById('cancelEdit').addEventListener('click', closeEditor);
      }

      function closeEditor() {
        const overlay = document.getElementById('editorOverlay');
        if (overlay) {
          overlay.remove();
          document.body.classList.remove('overflow-hidden');
        }
      }

      function saveItem(key, id) {
        const titleField = document.getElementById('itemTitle');
        const emoteCodeField = document.getElementById('itemEmoteCode');
        const contentField = document.getElementById('itemContent');
        const ingredientsField = document.getElementById('itemIngredients');
        const effectsField = document.getElementById('itemEffects');
        const incantationField = document.getElementById('itemIncantation');
        const professorField = document.getElementById('itemProfessor');
        const locationField = document.getElementById('itemLocation');
        const locationSelect = document.getElementById('itemLocationSelect');
        if (!titleField || !contentField) return;
        const title = titleField.value.trim();
        const emoteCodeInput = emoteCodeField ? emoteCodeField.value.trim() : '';
        const normalizedEmote = emoteToSymbol(emoteCodeInput);
        const body = contentField.value.trim();
        const ingredients = ingredientsField ? ingredientsField.value.trim() : undefined;
        const effects = effectsField ? effectsField.value.trim() : undefined;
        const incantation = incantationField ? incantationField.value.trim() : undefined;
        const professor = professorField ? professorField.value.trim() : undefined;
        const usageSelect = document.getElementById('itemUsage');
        const usageValue = usageSelect ? usageSelect.value : undefined;
        const manualLocation = locationField ? locationField.value.trim() : '';
        const selectedLocation = locationSelect ? locationSelect.value.trim() : '';
        const finalLocation = manualLocation || selectedLocation || undefined;
        const isRecipe = ingredientCategories.has(key);
        if (!title) {
          pushToast('Veuillez nommer votre Ã©lÃ©ment.', 'danger');
          return;
        }
        if (!isRecipe && !body && key !== 'ingredients') {
          pushToast('Merci dâ€™ajouter une description.', 'danger');
          return;
        }
        if (key === 'ingredients' && !finalLocation) {
          pushToast('Merci de prÃ©ciser un emplacement ou une carte.', 'danger');
          return;
        }
        const nextItem = {
          title,
          emoteCode: emoteCodeInput,
          emote: normalizedEmote,
          content: body,
          ...(ingredientsField ? { ingredients } : {}),
          ...(effectsField ? { effects } : {}),
          ...(incantationField ? { incantation } : {}),
          ...(professorField ? { professor } : {}),
          ...(key === 'ingredients' ? { location: finalLocation || '', usage: usageValue || 'cuisine' } : {}),
          ...(key === 'recettes-potions' ? { classification: document.getElementById('itemClassification')?.value || 'normale' } : {}),
          ...((key === 'creatures' || key === 'botanique')
            ? {
                danger: document.getElementById('itemDanger')?.value.trim() || '',
                size: document.getElementById('itemSize')?.value.trim() || '',
                sex: key === 'creatures' ? document.getElementById('itemSex')?.value.trim() || '' : undefined,
                weight: key === 'creatures' ? document.getElementById('itemWeight')?.value.trim() || '' : undefined,
                physical: document.getElementById('itemPhysical')?.value.trim() || '',
                habitat: document.getElementById('itemHabitat')?.value.trim() || '',
                info: document.getElementById('itemInfo')?.value.trim() || '',
                photo: document.getElementById('itemPhoto')?.value.trim() || ''
              }
            : {})
        };
        if (id) {
          library[key] = (library[key] || []).map((entry) => entry.id === id ? { ...entry, ...nextItem } : entry);
          pushToast('Ã‰lÃ©ment mis Ã  jour.');
        } else {
          const newItem = { id: `${key}-${Date.now()}`, ...nextItem };
          library[key] = [...(library[key] || []), newItem];
          pushToast('Nouvel Ã©lÃ©ment enregistrÃ©.');
        }
        persistState();
        closeEditor();
        renderCategory(key);
      }

      function deleteItem(key, id) {
        library[key] = (library[key] || []).filter((entry) => entry.id !== id);
        pushToast('Ã‰lÃ©ment effacÃ©.', 'danger');
        persistState();
        closeEditor();
        renderCategory(key);
      }

      function enableItemListInteractions(key) {
        const toggleBtn = document.getElementById('toggleEditing');
        const listContainers = (key === 'ingredients' || key === 'recettes-potions')
          ? Array.from(document.querySelectorAll('[data-item-list]'))
          : [document.getElementById('itemList')].filter(Boolean);
        if (!toggleBtn || !listContainers.length) return;
        toggleBtn.addEventListener('click', () => {
          editingState[key] = !editingState[key];
          applyEditingState(key);
        });
        listContainers.forEach((itemList) => {
          itemList.addEventListener('click', (event) => handleListClick(event, key));
          itemList.addEventListener('dragstart', (event) => handleDragStart(event, key));
          itemList.addEventListener('dragover', (event) => handleDragOver(event, key));
          itemList.addEventListener('dragend', (event) => handleDragEnd(event, key));
          itemList.addEventListener('drop', (event) => event.preventDefault());
          itemList.addEventListener('click', (event) => {
            const locationLink = event.target.closest('[data-map-location-url]');
            if (locationLink) {
              event.stopPropagation();
              const url = locationLink.dataset.mapLocationUrl;
              openMapFullscreen(url);
            }
          });
        });
        applyEditingState(key);
      }

      function applyEditingState(key) {
        const toggleBtn = document.getElementById('toggleEditing');
        if (!toggleBtn) return;
        const editing = !!editingState[key];
        toggleBtn.textContent = editing ? 'Terminer les modifications' : 'Cliquez pour modifier';
        const lists = (key === 'ingredients' || key === 'recettes-potions')
          ? document.querySelectorAll('[data-item-list]')
          : [document.getElementById('itemList')].filter(Boolean);
        lists.forEach((itemList) => {
          if (!itemList) return;
          itemList.classList.toggle('list-editing', editing);
          itemList.querySelectorAll('li[data-id]').forEach((node) => node.setAttribute('draggable', editing));
        });
        if (sectionsWithEditTips.has(key)) {
          const editTips = document.getElementById('editTips');
          if (editTips) {
            editTips.classList.toggle('hidden', !editing);
          }
        }
      }

      function handleListClick(event, key) {
        const deleteBtn = event.target.closest('.delete-item');
        if (deleteBtn) {
          const li = deleteBtn.closest('li[data-id]');
          if (li) {
            deleteItem(key, li.dataset.id);
          }
          return;
        }
        const editBtn = event.target.closest('.edit-item');
        if (editBtn) {
          const li = editBtn.closest('li[data-id]');
          if (li) {
            openEditor(key, li.dataset.id);
          }
          return;
        }
        if (editingState[key]) {
          return;
        }
        const itemCard = event.target.closest('li[data-id]');
        if (itemCard) {
          const details = itemCard.querySelector('.item-details');
          const expanded = itemCard.dataset.expanded === 'true';
          itemCard.dataset.expanded = (!expanded).toString();
          if (details) {
            details.classList.toggle('hidden', expanded);
          }
        }
      }

      function handleDragStart(event, key) {
        if (!editingState[key]) {
          event.preventDefault();
          return;
          }
        const itemCard = event.target.closest('li[data-id]');
        if (!itemCard) {
          event.preventDefault();
          return;
        }
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', itemCard.dataset.id);
        itemCard.classList.add('dragging');
      }

      function handleDragOver(event, key) {
        if (!editingState[key]) return;
        const itemList = event.currentTarget;
        if (!itemList) return;
        const dragging = itemList.querySelector('.dragging');
        if (!dragging) return;
        const target = event.target.closest('li[data-id]');
        if (!target || target === dragging || !itemList.contains(target)) return;
        event.preventDefault();
        const rect = target.getBoundingClientRect();
        const shouldPlaceBefore = event.clientY < rect.top + rect.height / 2;
        if (shouldPlaceBefore) {
          itemList.insertBefore(dragging, target);
        } else {
          itemList.insertBefore(dragging, target.nextSibling);
        }
      }

      function handleDragEnd(event, key) {
        if (!editingState[key]) return;
        const lists = key === 'ingredients'
          ? document.querySelectorAll('[data-item-list]')
          : [document.getElementById('itemList')].filter(Boolean);
        lists.forEach((list) => {
          const dragging = list?.querySelector('.dragging');
          if (dragging) dragging.classList.remove('dragging');
        });
        updateLibraryOrder(key);
      }

      function updateLibraryOrder(key) {
        const current = library[key] || [];
        if (key === 'ingredients') {
          const cuisineList = document.querySelector('[data-item-list][data-usage="cuisine"]');
          const potionList = document.querySelector('[data-item-list][data-usage="potion"]');
          const cuisineIds = cuisineList ? Array.from(cuisineList.querySelectorAll('li[data-id]')).map((node) => node.dataset.id) : [];
          const potionIds = potionList ? Array.from(potionList.querySelectorAll('li[data-id]')).map((node) => node.dataset.id) : [];
          const orderedIds = [...cuisineIds, ...potionIds];
          if (!orderedIds.length) {
            renderCategory(key);
            return;
          }
          const idToUsage = new Map();
          cuisineIds.forEach((id) => idToUsage.set(id, 'cuisine'));
          potionIds.forEach((id) => idToUsage.set(id, 'potion'));
          const newOrder = orderedIds
            .map((id) => current.find((item) => item.id === id))
            .filter(Boolean)
            .map((item) => ({ ...item, usage: idToUsage.get(item.id) || item.usage || 'cuisine' }))
            .concat(current.filter((item) => !orderedIds.includes(item.id)));
          const hasChanged = newOrder.some((item, idx) => item?.id !== current[idx]?.id);
          library[key] = newOrder;
          if (hasChanged) {
            pushToast('Ordre mis Ã  jour.');
          }
          persistState();
          editingState[key] = true;
          renderCategory(key);
          return;
        }
        if (key === 'recettes-potions') {
          const columns = ['naniss', 'normale', 'grande', 'mega'];
          const idsPerCol = columns.map((cls) => {
            const list = document.querySelector(`[data-item-list][data-classification="${cls}"]`);
            return list ? Array.from(list.querySelectorAll('li[data-id]')).map((node) => node.dataset.id) : [];
          });
          const orderedIds = idsPerCol.flat();
          if (!orderedIds.length) {
            renderCategory(key);
            return;
          }
          const idToClass = new Map();
          columns.forEach((cls, idx) => idsPerCol[idx].forEach((id) => idToClass.set(id, cls)));
          const newOrder = orderedIds
            .map((id) => current.find((item) => item.id === id))
            .filter(Boolean)
            .map((item) => ({ ...item, classification: idToClass.get(item.id) || item.classification || 'normale' }))
            .concat(current.filter((item) => !orderedIds.includes(item.id)));
          const hasChanged = newOrder.some((item, idx) => item?.id !== current[idx]?.id);
          library[key] = newOrder;
          if (hasChanged) {
            pushToast('Ordre mis Ã  jour.');
          }
          persistState();
          editingState[key] = true;
          renderCategory(key);
          return;
        }
        const itemList = document.getElementById('itemList');
        if (!itemList) return;
        const ids = Array.from(itemList.querySelectorAll('li[data-id]')).map((node) => node.dataset.id);
        if (!ids.length) {
          renderCategory(key);
          return;
        }
        const newOrder = ids
          .map((id) => current.find((item) => item.id === id))
          .filter(Boolean)
          .concat(current.filter((item) => !ids.includes(item.id)));
        const hasChanged = newOrder.some((item, idx) => item?.id !== current[idx]?.id);
        library[key] = newOrder;
        if (hasChanged) {
          pushToast('Ordre mis Ã  jour.');
        }
        persistState();
        editingState[key] = true;
        renderCategory(key);
      }

      showSection('accueil');
      applyHeaderBackground();

      const emojiToggle = document.getElementById('emojiToggle');
      const emojiOverlay = document.getElementById('emojiOverlay');
      const closeEmoji = document.getElementById('closeEmoji');
      if (emojiToggle && emojiOverlay) {
        emojiToggle.addEventListener('click', () => toggleEmojiOverlay(true));
        emojiOverlay.addEventListener('click', () => toggleEmojiOverlay(false));
        const panel = emojiOverlay.querySelector('.emoji-panel');
        if (panel) {
          panel.addEventListener('click', (event) => event.stopPropagation());
        }
      }
      if (closeEmoji) {
        closeEmoji.addEventListener('click', () => toggleEmojiOverlay(false));
      }

      const bgEditorToggle = document.getElementById('bgEditorToggle');
      const bgEditorOverlay = document.getElementById('bgEditorOverlay');
      const closeBgEditor = document.getElementById('closeBgEditor');
      const editHeaderBgBtn = document.getElementById('editHeaderBg');
      const editBodyBgBtn = document.getElementById('editBodyBg');

      function toggleBgEditorOverlay(show) {
        if (!bgEditorOverlay) return;
        bgEditorOverlay.classList.toggle('is-visible', show);
      }

      if (bgEditorToggle && bgEditorOverlay) {
        bgEditorToggle.addEventListener('click', () => toggleBgEditorOverlay(true));
        bgEditorOverlay.addEventListener('click', () => toggleBgEditorOverlay(false));
        const panel = bgEditorOverlay.querySelector('.emoji-panel');
        if (panel) {
          panel.addEventListener('click', (event) => event.stopPropagation());
        }
      }
      if (closeBgEditor) {
        closeBgEditor.addEventListener('click', () => toggleBgEditorOverlay(false));
      }
      if (editHeaderBgBtn && headerBgInput) {
        editHeaderBgBtn.addEventListener('click', () => headerBgInput.click());
      }
      if (headerBgInput) {
        headerBgInput.addEventListener('change', handleHeaderBackgroundUpload);
      }
      if (editBodyBgBtn && bodyBgInput) {
        editBodyBgBtn.addEventListener('click', () => bodyBgInput.click());
      }
      if (bodyBgInput) {
        bodyBgInput.addEventListener('change', handleBodyBackgroundUpload);
      }
    });
  </script>
</body>
</html>
